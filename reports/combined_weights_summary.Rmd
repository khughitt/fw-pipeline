---
title: "Comparison of Gene Weights"
date: "`r strftime(Sys.time(), '%Y-%m-%d')`"
params:
   rmd: "combined_weights_summary.Rmd"
output:
  html_document:
    df_print: kable
    toc: true
    toc_depth: 2
---

# Overview

In this file, different versions of the gene weightings (generated via different
gene-phenotype associations methods or parameters and different methods for generating
combined weights from the inidivual sources) are compared.

Naming Conventions:

- **dataset**: `XX_pearson_max` -- maximum feature-pheno pearson correlation used as weight
- **field**: `max_score`: when combining weights from different sources, the maximum
  value is used.

(Note: the handling and presentation of dataset sources, methods used to measure
gene-phenotype associations, and methods for collapsing individual dataset weights needs
to be improved..)

# Setup

```{r setup, message = FALSE}
library(fgsea)
library(knitr)
library(gridExtra)
library(GSEABase)
library(tidyverse)

options(stringsAsFactors = FALSE)
options(digits = 3)

opts_chunk$set(fig.width = 20, fig.height = 11.24, dpi = 192, retina = 1)
```

# Feature Weights

```{r load_feature_weights}
# load feature weights
gene_weight_files <- c(snakemake@input$indiv_weights, snakemake@input$combined_weights)

wts_list <- lapply(gene_weight_files, read_tsv, col_types = cols())

# todo: replace with cleaner method of keeping track of dataset ids
ids <- sub(paste0(snakemake@config$output_dir, '/'), '', unlist(gene_weight_files))
ids <- sub('weights/', '', sub('.tsv.gz', '', ids))

# temp: "gdsc1000/0.1/genes/rna/auc_recomputed" -> "gdsc1000_auc_recomputed"
# note: this cleaning appears in two places in the file: once for gene weights, and once
# for fgsea results..
ids[grepl('/', ids)] <- unlist(lapply(lapply(str_split(ids[grepl('/', ids)], '/'), '[', c(1, 5)), paste0, collapse = '_'))

names(wts_list) <- ids

sapply(wts_list, nrow)
sapply(wts_list, ncol)
```

```{r include = FALSE}
# debug
if (snakemake@config$dev_mode$enabled) {
  save.image('/rda/nih/fw/combined_weights_summary.rda')
}
```

## Distribution of Feature Weghts

```{r, results = 'asis', dpi = 128}
for (dataset_id in names(wts_list)) {
  cat(sprintf("### %s\n", dataset_id))

  dataset <- wts_list[[dataset_id]]

  plts <- list()

  for (feat_wt in colnames(dataset)[-1]) {
    plt_title <- sprintf("%s - %s", dataset_id, feat_wt)

    if (grepl('auc', feat_wt)) {
      plt_color <- '#e31a51'
    } else if(grepl('ic50', feat_wt)) {
      plt_color <- '#4fe319'
    } else {
      plt_color <- '#194fe3'
    }

    plt_dat <- data.frame(x = dataset[[feat_wt]])
    plts[[plt_title]] <- ggplot(plt_dat, aes(x)) +
      geom_density(fill = plt_color) +
      xlab('weight') +
      ggtitle(plt_title)
  }

  grid.arrange(grobs = plts, ncol = 3)

  cat('\n')
}
```

# Top genes

```{r, results = 'asis'}
for (dataset_id in names(wts_list)) {
  cat(sprintf("## %s\n", dataset_id))

  wts <- wts_list[[dataset_id]] %>%
    pivot_longer(-symbol, names_to = 'method', values_to = 'score')

  for (score_method in unique(wts$method)) {
    cat(sprintf("### %s\n", score_method))

    wts %>%
      filter(method == score_method) %>%
      select(-method) %>%
      arrange(desc(score)) %>%
      head(15) %>%
      kable() %>%
      print()

    cat('\n')
  }
}
```

# Gene weight functional enrichment

```{r load_fgsea_results}
# load fgsea results
fgsea_res_files <- c(snakemake@input$indiv_fgsea, snakemake@input$combined_fgsea)

fgsea_list <- lapply(fgsea_res_files, read_tsv, col_types = cols())

# temp: handling of dataset/method names needs to be cleaned up...
ids <- sub(paste0(snakemake@config$output_dir, '/'), '', unlist(fgsea_res_files))
ids <- sub('_fgsea', '', sub('fgsea/', '', sub('.tsv.gz', '', ids)))

# just pretend you didn't see this... (will be replaced)
ids[grepl('/', ids)] <- unlist(lapply(lapply(str_split(ids[grepl('/', ids)], '/'), '[', c(1, 5)), paste0, collapse = '_'))

names(fgsea_list) <- ids

# combine fgsea results into a single dataframe
fgsea_res <- NULL

for (dataset in names(fgsea_list)) {
  fgsea_res <- rbind(fgsea_res, cbind(dataset, fgsea_list[[dataset]]))
}

# temp: drop entries with no p-values (moved upstream..; can remove this in future..)
fgsea_res <- fgsea_res[complete.cases(fgsea_res), ]
```

```{r load_gene_sets}
config <- snakemake@config$gene_sets

gene_set_files <- file.path(config$include, list.files(config$include))

gene_set_collections <- lapply(gene_set_files, function(x) {
  res <- geneIds(getGmt(x))
  lapply(res, function(gene_set) {
    gene_set[gene_set != '']
  })
})
names(gene_set_collections) <- tools::file_path_sans_ext(basename(gene_set_files))

# remove gene set :length suffixes, if present
names(gene_set_collections) <- sub(':\\d+$', '', names(gene_set_collections))

# remove any leading or trailing whitespace in gene set names;
# encountered at least one instance of this ("HEK 293 T-rex" in NCI-60 gene set
# collection)
for (collection in names(gene_set_collections)) {
  names(gene_set_collections[[collection]]) <- trimws(names(gene_set_collections[[collection]]))
}

# remove gene set weights, if present
# e.g. "ANXA1,1.0" -> "ANXA1"
for (collection in names(gene_set_collections)) {
  gene_set_collections[[collection]] <- lapply(gene_set_collections[[collection]], function(x) {
    sub(',\\d+\\.\\d+$', '', x)
  })
}

# exclude any gene sets which are either too large or too small
for (collection in names(gene_set_collections)) {
  set_sizes <- lapply(gene_set_collections[[collection]], length)
  mask <- (set_sizes >= config$min_size) & (set_sizes <= config$max_size)
  gene_set_collections[[collection]] <- gene_set_collections[[collection]][mask]
}
```

## Gene weight vesions ranked by level of functional enrichment

```{r enrichment_by_weights_dataset}
fgsea_res %>%
  group_by(dataset, field) %>%
  summarize(mean_pval = mean(pval), median_pval = median(pval),
            num_sig = sum(padj < 0.05),
            n = n()) %>%
  arrange(mean_pval)
```

## Gene set collections with the highest levels of enrichment

```{r gene_set_enrichment_comparison}
fgsea_res %>%
  group_by(gene_set) %>%
  summarize(mean_pval = mean(pval), median_pval = median(pval),
            ratio_sig = sum(padj < 0.05) / length(padj),
            n = n()) %>%
  arrange(mean_pval)
```

```{r include = FALSE}
if (snakemake@config$dev_mode$enabled) {
  save.image('/rda/nih/fw/combined_weights_summary.rda')
}
```

# Top pathways / gene sets

```{r}
# for comparison, we will show the same gene sets for each of the different feature
# weight versions

# get the top enriched pathway for each version of the gene weights
top_gene_sets <- fgsea_res %>%
  group_by(dataset, field) %>%
  arrange(pval) %>%
  slice(1) %>%
  ungroup() %>%
  select(gene_set, pathway)

top_gene_sets <- top_gene_sets[!duplicated(top_gene_sets), ]

for (i in seq_along(nrow(top_gene_sets))) {
  collection <- top_gene_sets$gene_set[i]

  gene_set   <- top_gene_sets$pathway[i]

  for (dataset_id in unique(fgsea_res$dataset)) {
    weights_dat <- wts_list[[dataset_id]]

    grid_title <- sprintf("%s: %s (%s)", dataset_id, gene_set, collection)

    print(grid_title)

    plts <- list()

    for (weight_col in colnames(weights_dat)[-1]) {
      feat_weights <- weights_dat %>%
        select(symbol, weight_col) %>%
        deframe()

      # DEV
      feat_weights <- feat_weights[!is.na(feat_weights)]

      plt_title <- sprintf('%s / %s', dataset_id, weight_col)

      idx <- sprintf("%s_%s", dataset_id, weight_col)

      gene_sets <- gene_set_collections[[collection]][[gene_set]]

      plts[[idx]] <- plotEnrichment(gene_sets,  feat_weights) +
        labs(title = plt_title)
    }
    grid.arrange(grobs = plts, ncol = ceiling(sqrt(length(plts))), top = grid_title)
  }
}
```

# Session Information

```{r}
sessionInfo()
```

